<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SaaS Dashboard | SMS Intelligence Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #6366f1; --success: #10b981; --danger: #ef4444; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; text-align: center; }
        .label { color: #94a3b8; font-size: 12px; text-transform: uppercase; margin-bottom: 10px; }
        .val { font-size: 24px; font-weight: 700; }
        .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--card); border-radius: 12px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #334155; font-size: 14px; }
        th { background: #2d3748; color: #94a3b8; }
    </style>
</head>
<body>
    <h1>SMS Real-Time Analytics</h1>
    <p id="status">Cargando base de datos histórica...</p>

    <div class="grid" id="kpis"></div>

    <div class="charts">
        <div class="card"><h3>Top Destinos (SMS Reales)</h3><canvas id="chartCountry"></canvas></div>
        <div class="card"><h3>Tendencia de Tráfico</h3><canvas id="chartTrend"></canvas></div>
    </div>

    <div class="card" style="margin-top:20px">
        <h3>Rentabilidad por Cliente</h3>
        <table id="clientTable">
            <thead><tr><th>Compañía</th><th>SMS Enviados</th><th>Ingresos (USD)</th><th>Costos (USD)</th><th>Margen</th><th>Efectividad</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let raw = [];
        let charts = {};

        fetch('datos/reporte_actual.xlsx').then(r => r.arrayBuffer()).then(buffer => {
            const wb = XLSX.read(buffer, {type:'array'});
            raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            document.getElementById('status').innerText = "Datos sincronizados correctamente.";
            render();
        });

        function render() {
            // CÁLCULOS SUMANDO MessageParts (LO REAL)
            const totalSMS = raw.reduce((s, d) => s + (d.MessageParts || 0), 0);
            const totalRev = raw.reduce((s, d) => s + (d.ClientCostUSD || 0), 0);
            const totalCost = raw.reduce((s, d) => s + (d.TerminationCostUSD || 0), 0);
            const deliveredSMS = raw.filter(d => d.DLRStatus === 'Delivered').reduce((s, d) => s + (d.MessageParts || 0), 0);
            
            // PROMEDIO PESADO DE DELAY (Si existe la columna)
            const totalDelay = raw.reduce((s, d) => s + ((d.DLRDelay || 0) * (d.MessageParts || 1)), 0);
            const avgDelay = totalSMS > 0 ? (totalDelay / totalSMS).toFixed(2) : 0;

            document.getElementById('kpis').innerHTML = `
                <div class="card"><div class="label">SMS Reales</div><div class="val">${totalSMS.toLocaleString()}</div></div>
                <div class="card"><div class="label">Entrega (DLR)</div><div class="val" style="color:var(--success)">${((deliveredSMS/totalSMS)*100).toFixed(1)}%</div></div>
                <div class="card"><div class="label">Latencia Promedio</div><div class="val" style="color:#f59e0b">${avgDelay}s</div></div>
                <div class="card"><div class="label">Utilidad Neta</div><div class="val" style="color:var(--success)">$${(totalRev - totalCost).toFixed(2)}</div></div>
            `;

            renderCharts();
            renderTable();
        }

        function renderCharts() {
            // Brazil y otros países sumando VOLUMEN
            const countries = {};
            raw.forEach(d => countries[d.CountryRealName] = (countries[d.CountryRealName] || 0) + (d.MessageParts || 0));
            const top = Object.entries(countries).sort((a,b) => b[1]-a[1]).slice(0,10);

            if(charts.c) charts.c.destroy();
            charts.c = new Chart(document.getElementById('chartCountry'), {
                type: 'bar',
                data: { labels: top.map(x=>x[0]), datasets: [{ label: 'Mensajes', data: top.map(x=>x[1]), backgroundColor: '#6366f1' }] }
            });

            const trend = {};
            raw.forEach(d => trend[d.SubmitDate] = (trend[d.SubmitDate] || 0) + (d.MessageParts || 0));
            const sorted = Object.entries(trend).sort((a,b) => a[0].localeCompare(b[0]));

            if(charts.t) charts.t.destroy();
            charts.t = new Chart(document.getElementById('chartTrend'), {
                type: 'line',
                data: { labels: sorted.map(x=>x[0]), datasets: [{ label: 'SMS', data: sorted.map(x=>x[1]), borderColor: '#10b981', tension: 0.3 }] }
            });
        }

        function renderTable() {
            const clients = {};
            raw.forEach(d => {
                if(!clients[d.CompanyName]) clients[d.CompanyName] = {v:0, r:0, c:0, d:0};
                clients[d.CompanyName].v += (d.MessageParts || 0);
                clients[d.CompanyName].r += (d.ClientCostUSD || 0);
                clients[d.CompanyName].c += (d.TerminationCostUSD || 0);
                if(d.DLRStatus === 'Delivered') clients[d.CompanyName].d += (d.MessageParts || 0);
            });

            const html = Object.entries(clients).sort((a,b) => b[1].r - a[1].r).map(([name, d]) => `
                <tr>
                    <td><b>${name}</b></td>
                    <td>${d.v.toLocaleString()}</td>
                    <td>$${d.r.toFixed(2)}</td>
                    <td>$${d.c.toFixed(2)}</td>
                    <td style="color:var(--success)">$${(d.r - d.c).toFixed(2)}</td>
                    <td>${((d.d / d.v)*100).toFixed(1)}%</td>
                </tr>
            `).join('');
            document.querySelector('#clientTable tbody').innerHTML = html;
        }
    </script>
</body>
</html>
