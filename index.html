<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SaaS Dashboard | SMS Analytics Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --surface: #1e293b; --primary: #6366f1; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --text: #f8fafc; --border: #334155; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 24px; }
        .card { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 24px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .input-group label { display: block; font-size: 11px; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        select, input { width: 100%; background: #0f172a; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; outline: none; transition: border-color 0.2s; }
        select:focus, input:focus { border-color: var(--primary); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .kpi-card { padding: 24px; border-left: 4px solid var(--primary); }
        .kpi-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; font-weight: 600; }
        .kpi-value { font-size: 28px; font-weight: 700; }
        .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px; margin-bottom: 32px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; font-size: 11px; text-transform: uppercase; color: #94a3b8; border-bottom: 2px solid var(--border); }
        td { padding: 14px 12px; font-size: 14px; border-bottom: 1px solid var(--border); }
        tr:hover td { background: rgba(255,255,255,0.02); }
        #status-bar { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-ok { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>SMS Financial Control</h1>
            <p style="color: #94a3b8">Datos históricos unificados y auditados en USD</p>
        </div>
        <div id="status-bar" class="status-ok">Sincronizando...</div>
    </div>

    <div class="card filter-grid">
        <div class="input-group"><label>Desde</label><input type="date" id="f-start"></div>
        <div class="input-group"><label>Hasta</label><input type="date" id="f-end"></div>
        <div class="input-group"><label>Cliente</label><select id="f-client"></select></div>
        <div class="input-group"><label>País</label><select id="f-country"></select></div>
        <div class="input-group"><label>Operador</label><select id="f-operator"></select></div>
    </div>

    <div class="kpi-grid" id="kpis"></div>

    <div class="charts-row">
        <div class="card"><h3>Volumen Real por Destino (SMS Parts)</h3><canvas id="chartCountry"></canvas></div>
        <div class="card"><h3>Tendencia de Tráfico Diaria</h3><canvas id="chartTrend"></canvas></div>
    </div>

    <div class="card" style="overflow-x: auto;">
        <h3>Desglose Financiero por Cliente</h3>
        <table>
            <thead>
                <tr>
                    <th>Compañía</th>
                    <th>Mensajes (Total)</th>
                    <th>Ingresos (USD)</th>
                    <th>Costos (USD)</th>
                    <th>Utilidad</th>
                    <th>Margen %</th>
                    <th>DLR %</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        let rawData = [];
        let charts = {};

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('datos/reporte_actual.xlsx');
                const buffer = await res.arrayBuffer();
                const wb = XLSX.read(buffer, { type: 'array' });
                rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                document.getElementById('status-bar').innerText = "✅ " + rawData.length + " Grupos Cargados";
                init();
            } catch (e) {
                document.getElementById('status-bar').innerText = "❌ Error de Carga";
                document.getElementById('status-bar').style.color = "var(--danger)";
            }
        });

        function init() {
            const fill = (id, key) => {
                const s = document.getElementById(id);
                const items = [...new Set(rawData.map(d => d[key]))].sort();
                s.innerHTML = '<option value="">Todos</option>';
                items.forEach(i => s.appendChild(new Option(i, i)));
            };
            fill('f-client', 'CompanyName');
            fill('f-country', 'CountryRealName');
            fill('f-operator', 'OperatorName');

            ['f-start', 'f-end', 'f-client', 'f-country', 'f-operator'].forEach(id => {
                document.getElementById(id).addEventListener('change', update);
            });
            update();
        }

        function update() {
            const start = document.getElementById('f-start').value;
            const end = document.getElementById('f-end').value;
            const client = document.getElementById('f-client').value;
            const country = document.getElementById('f-country').value;
            const op = document.getElementById('f-operator').value;

            const filtered = rawData.filter(d => {
                return (!start || d.SubmitDate >= start) &&
                       (!end || d.SubmitDate <= end) &&
                       (!client || d.CompanyName === client) &&
                       (!country || d.CountryRealName === country) &&
                       (!op || d.OperatorName === op);
            });

            renderDashboard(filtered);
        }

        function renderDashboard(data) {
            // MATEMÁTICA REAL: SUMA DE MessageParts PARA VOLUMEN
            const totalVol = data.reduce((s, d) => s + (d.MessageParts || 0), 0);
            const totalRev = data.reduce((s, d) => s + (d.ClientCostUSD || 0), 0);
            const totalCost = data.reduce((s, d) => s + (d.TerminationCostUSD || 0), 0);
            const totalProfit = totalRev - totalCost;
            
            const delivered = data.filter(d => d.DLRStatus === 'Delivered').reduce((s, d) => s + (d.MessageParts || 0), 0);
            const deliveryRate = totalVol > 0 ? (delivered / totalVol * 100).toFixed(1) : 0;

            // Promedio pesado de latencia
            const totalDelay = data.reduce((s, d) => s + ((d.DLRDelay || 0) * (d.MessageParts || 1)), 0);
            const avgDelay = totalVol > 0 ? (totalDelay / totalVol).toFixed(2) : 0;

            document.getElementById('kpis').innerHTML = `
                <div class="card kpi-card"><div class="kpi-label">Mensajes Enviados</div><div class="kpi-value">${totalVol.toLocaleString()}</div></div>
                <div class="card kpi-card" style="border-left-color: var(--success)"><div class="kpi-label">Ingresos Totales (USD)</div><div class="kpi-value">$${totalRev.toLocaleString(undefined, {minimumFractionDigits: 2})}</div></div>
                <div class="card kpi-card" style="border-left-color: var(--danger)"><div class="kpi-label">Utilidad Neta</div><div class="kpi-value" style="color: var(--success)">$${totalProfit.toLocaleString(undefined, {minimumFractionDigits: 2})}</div></div>
                <div class="card kpi-card" style="border-left-color: var(--warning)"><div class="kpi-label">Eficiencia DLR / Latencia</div><div class="kpi-value">${deliveryRate}% <small style="font-size:14px; color:#94a3b8">/ ${avgDelay}s</small></div></div>
            `;

            renderCharts(data);
            renderTable(data);
        }

        function renderCharts(data) {
            // Top Países (Brazil corregido)
            const countries = {};
            data.forEach(d => countries[d.CountryRealName] = (countries[d.CountryRealName] || 0) + (d.MessageParts || 0));
            const top = Object.entries(countries).sort((a,b) => b[1]-a[1]).slice(0,10);

            if(charts.c) charts.c.destroy();
            charts.c = new Chart(document.getElementById('chartCountry'), {
                type: 'bar',
                data: { labels: top.map(x=>x[0]), datasets: [{ label: 'SMS Parts', data: top.map(x=>x[1]), backgroundColor: '#6366f1', borderRadius: 6 }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#334155' } } } }
            });

            // Tendencia
            const trend = {};
            data.forEach(d => trend[d.SubmitDate] = (trend[d.SubmitDate] || 0) + (d.MessageParts || 0));
            const sorted = Object.entries(trend).sort((a,b) => a[0].localeCompare(b[0]));

            if(charts.t) charts.t.destroy();
            charts.t = new Chart(document.getElementById('chartTrend'), {
                type: 'line',
                data: { labels: sorted.map(x=>x[0]), datasets: [{ label: 'Volumen Diario', data: sorted.map(x=>x[1]), borderColor: '#10b981', tension: 0.3, fill: true, backgroundColor: 'rgba(16, 185, 129, 0.1)' }] },
                options: { plugins: { legend: { display: false } } }
            });
        }

        function renderTable(data) {
            const clients = {};
            data.forEach(d => {
                if(!clients[d.CompanyName]) clients[d.CompanyName] = {v:0, r:0, c:0, d:0};
                clients[d.CompanyName].v += (d.MessageParts || 0);
                clients[d.CompanyName].r += (d.ClientCostUSD || 0);
                clients[d.CompanyName].c += (d.TerminationCostUSD || 0);
                if(d.DLRStatus === 'Delivered') clients[d.CompanyName].d += (d.MessageParts || 0);
            });

            document.getElementById('table-body').innerHTML = Object.entries(clients).sort((a,b) => b[1].r - a[1].r).map(([name, d]) => {
                const profit = d.r - d.c;
                const margin = d.r > 0 ? (profit / d.r * 100).toFixed(1) : 0;
                return `
                    <tr>
                        <td style="font-weight: 600;">${name}</td>
                        <td>${d.v.toLocaleString()}</td>
                        <td>$${d.r.toFixed(2)}</td>
                        <td>$${d.c.toFixed(2)}</td>
                        <td style="color:var(--success); font-weight: 700;">$${profit.toFixed(2)}</td>
                        <td><span style="background:rgba(99,102,241,0.1); padding:4px 8px; border-radius:4px; color:var(--primary); font-size:12px;">${margin}%</span></td>
                        <td>${((d.d / d.v)*100).toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
